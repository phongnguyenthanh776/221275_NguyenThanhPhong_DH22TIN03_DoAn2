@model List<LichSuBMI>

@{
    ViewData["Title"] = "Lịch sử BMI";
}

<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-clock-history"></i> Lịch sử BMI</h2>
        <p class="text-muted">Theo dõi sự thay đổi BMI theo thời gian</p>
    </div>
</div>

@if (Model != null && Model.Any())
{
    <!-- Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> Biểu đồ BMI
                </div>
                <div class="card-body">
                    <canvas id="bmiHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-table"></i> Chi tiết lịch sử
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Chiều cao</th>
                                    <th>Cân nặng</th>
                                    <th>BMI</th>
                                    <th>Phân loại</th>
                                    <th>Lời khuyên</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.NgayTinh.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>@item.ChieuCao cm</td>
                                        <td>@item.CanNang kg</td>
                                        <td><strong>@item.BMI.ToString("0.00")</strong></td>
                                        <td>
                                            <span class="badge bg-light text-dark">@(!string.IsNullOrWhiteSpace(item.PhanLoai) ? item.PhanLoai : "-")</span>
                                        </td>
                                        <td><small>@(!string.IsNullOrWhiteSpace(item.GoiY) ? item.GoiY : "Chưa có khuyến nghị")</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Chưa có dữ liệu BMI. <a asp-action="CalculateBMI" class="alert-link">Tính BMI ngay</a>
    </div>
}

<div class="mt-3">
    <a asp-action="CalculateBMI" class="btn btn-primary">
        <i class="bi bi-calculator"></i> Tính BMI mới
    </a>
    <a asp-controller="Home" asp-action="Dashboard" class="btn btn-outline-secondary">
        <i class="bi bi-speedometer2"></i> Về Dashboard
    </a>
</div>

@section Scripts {
    @if (Model != null && Model.Any())
    {
        <script>
            const ctx = document.getElementById('bmiHistoryChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.OrderBy(b => b.NgayTinh).Select(b => $"'{b.NgayTinh:dd/MM}'")))],
                    datasets: [{
                        label: 'BMI',
                        data: [@string.Join(",", Model.OrderBy(b => b.NgayTinh).Select(b => b.BMI))],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: {
                            display: true,
                            text: 'Biến động BMI theo thời gian'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 15,
                            max: 35,
                            title: {
                                display: true,
                                text: 'BMI'
                            }
                        }
                    }
                }
            });
        </script>
    }
}
