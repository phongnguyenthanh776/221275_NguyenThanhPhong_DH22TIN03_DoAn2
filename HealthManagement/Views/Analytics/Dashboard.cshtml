@using HealthManagement.Services
@using HealthManagement.Models
@{
    ViewData["Title"] = "Phân Tích Sức Khỏe";
    var trends = ViewBag.Trends as HealthTrendAnalysis;
    var alerts = ViewBag.Alerts as List<HealthAlert>;
    var comparison = ViewBag.Comparison as HealthComparisonResult;
    var aiPredictions = trends?.AiPredictions ?? new List<PredictionResponse>();
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-graph-up-arrow"></i> Phân Tích Xu Hướng Sức Khỏe</h2>
            <p class="text-muted">Theo dõi và phân tích các chỉ số sức khỏe của bạn trong 30 ngày qua</p>
        </div>
    </div>

    <!-- HEALTH ALERTS -->
    @if (alerts != null && alerts.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Cảnh Báo Sức Khỏe (@alerts.Count)</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var alert in alerts)
                        {
                            var bgClass = alert.Severity == AlertSeverity.High ? "danger" : 
                                         alert.Severity == AlertSeverity.Medium ? "warning" : "info";
                            <div class="alert alert-@bgClass d-flex align-items-start mb-3" role="alert">
                                <div class="me-3" style="font-size: 2rem;">@alert.Icon</div>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading">@alert.Category: @alert.Title</h6>
                                    <p class="mb-1">@alert.Message</p>
                                    <hr>
                                    <p class="mb-0"><strong>Hành động cần thiết:</strong> @alert.ActionRequired</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle-fill"></i> <strong>Tuyệt vời!</strong> Hiện tại không có cảnh báo sức khỏe nào.
        </div>
    }

    <!-- AI RISK SNAPSHOT -->
    @if (aiPredictions.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-cpu"></i> Phân Tích Rủi Ro AI</h5>
                        <span class="badge bg-light text-dark">@aiPredictions.Count dự đoán</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var pred in aiPredictions)
                            {
                                var severityClass = pred.Result.ToLower().Contains("cao") ? "danger" :
                                                   pred.Result.ToLower().Contains("trung") ? "warning" : "success";
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 border rounded h-100">
                                        <p class="text-muted mb-1">@pred.DiseaseType</p>
                                        <h4 class="mb-1 text-@severityClass">@pred.Result</h4>
                                        <p class="mb-1">Rủi ro: <strong>@pred.RiskLevel.ToString("F1")%</strong></p>
                                        <small class="text-muted">@pred.Recommendation</small>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- OVERALL HEALTH SCORE -->
    @if (trends != null && trends.HasData)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <h3>Điểm Sức Khỏe Tổng Thể</h3>
                        <div class="progress" style="height: 40px; font-size: 1.2rem;">
                            @{
                                var scoreClass = trends.OverallHealthScore >= 80 ? "success" : 
                                                trends.OverallHealthScore >= 60 ? "warning" : "danger";
                            }
                            <div class="progress-bar bg-@scoreClass" role="progressbar" 
                                 style="width: @trends.OverallHealthScore%" 
                                 aria-valuenow="@trends.OverallHealthScore" aria-valuemin="0" aria-valuemax="100">
                                @trends.OverallHealthScore / 100
                            </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted">
                            @if (trends.OverallHealthScore >= 80)
                            {
                                <span class="text-success">Sức khỏe rất tốt! Hãy duy trì.</span>
                            }
                            else if (trends.OverallHealthScore >= 60)
                            {
                                <span class="text-warning">Sức khỏe khá. Cần cải thiện một số chỉ số.</span>
                            }
                            else
                            {
                                <span class="text-danger">Cần chú ý và cải thiện sức khỏe.</span>
                            }
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRENDS -->
        <div class="row mb-4">
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Huyết Áp</h6>
                        <h3 class="card-title text-primary">
                            @trends.BloodPressureTrend.TrendIcon @trends.BloodPressureTrend.Trend
                        </h3>
                        <p class="mb-1">
                            <small>Từ: <strong>@trends.BloodPressureTrend.FirstValue.ToString("F0")</strong></small>
                        </p>
                        <p class="mb-1">
                            <small>Đến: <strong>@trends.BloodPressureTrend.LastValue.ToString("F0")</strong></small>
                        </p>
                        <p class="mb-0">
                            <small class="@(trends.BloodPressureTrend.Change > 0 ? "text-danger" : "text-success")">
                                Thay đổi: @trends.BloodPressureTrend.Change.ToString("F1") 
                                (@trends.BloodPressureTrend.PercentChange.ToString("F1")%)
                            </small>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Đường Huyết</h6>
                        <h3 class="card-title text-warning">
                            @trends.BloodSugarTrend.TrendIcon @trends.BloodSugarTrend.Trend
                        </h3>
                        <p class="mb-1">
                            <small>Từ: <strong>@trends.BloodSugarTrend.FirstValue.ToString("F1")</strong></small>
                        </p>
                        <p class="mb-1">
                            <small>Đến: <strong>@trends.BloodSugarTrend.LastValue.ToString("F1")</strong></small>
                        </p>
                        <p class="mb-0">
                            <small class="@(trends.BloodSugarTrend.Change > 0 ? "text-danger" : "text-success")">
                                Thay đổi: @trends.BloodSugarTrend.Change.ToString("F1")
                                (@trends.BloodSugarTrend.PercentChange.ToString("F1")%)
                            </small>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Cholesterol</h6>
                        <h3 class="card-title text-danger">
                            @trends.CholesterolTrend.TrendIcon @trends.CholesterolTrend.Trend
                        </h3>
                        <p class="mb-1">
                            <small>Từ: <strong>@trends.CholesterolTrend.FirstValue.ToString("F1")</strong></small>
                        </p>
                        <p class="mb-1">
                            <small>Đến: <strong>@trends.CholesterolTrend.LastValue.ToString("F1")</strong></small>
                        </p>
                        <p class="mb-0">
                            <small class="@(trends.CholesterolTrend.Change > 0 ? "text-danger" : "text-success")">
                                Thay đổi: @trends.CholesterolTrend.Change.ToString("F1")
                                (@trends.CholesterolTrend.PercentChange.ToString("F1")%)
                            </small>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Nhịp Tim</h6>
                        <h3 class="card-title text-info">
                            @trends.HeartRateTrend.TrendIcon @trends.HeartRateTrend.Trend
                        </h3>
                        <p class="mb-1">
                            <small>Từ: <strong>@trends.HeartRateTrend.FirstValue.ToString("F0")</strong></small>
                        </p>
                        <p class="mb-1">
                            <small>Đến: <strong>@trends.HeartRateTrend.LastValue.ToString("F0")</strong></small>
                        </p>
                        <p class="mb-0">
                            <small class="@(Math.Abs(trends.HeartRateTrend.Change) > 10 ? "text-warning" : "text-success")">
                                Thay đổi: @trends.HeartRateTrend.Change.ToString("F1")
                                (@trends.HeartRateTrend.PercentChange.ToString("F1")%)
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PERIOD INFO -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Thông Tin Phân Tích</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Thời gian:</strong> @trends.Period ngày</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Số lần đo:</strong> @trends.TotalRecords</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Từ ngày:</strong> @trends.StartDate.ToString("dd/MM/yyyy")</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0"><strong>Đến ngày:</strong> @trends.EndDate.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i> Chưa có đủ dữ liệu để phân tích xu hướng. Hãy nhập chỉ số sức khỏe thường xuyên!
        </div>
    }

    <!-- COMPARISON WITH AVERAGE -->
    @if (comparison != null && comparison.HasData)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> So Sánh Với Mức Trung Bình</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h6>Huyết Áp</h6>
                                <p class="mb-0">
                                    <strong class="@(comparison.UserBloodPressure > comparison.AverageBloodPressure ? "text-danger" : "text-success")">
                                        @comparison.UserBloodPressure
                                    </strong> / @comparison.AverageBloodPressure (TB)
                                </p>
                            </div>
                            <div class="col-md-3">
                                <h6>Đường Huyết</h6>
                                <p class="mb-0">
                                    <strong class="@(comparison.UserBloodSugar > comparison.AverageBloodSugar ? "text-danger" : "text-success")">
                                        @comparison.UserBloodSugar.ToString("F1")
                                    </strong> / @comparison.AverageBloodSugar.ToString("F1") (TB)
                                </p>
                            </div>
                            <div class="col-md-3">
                                <h6>Cholesterol</h6>
                                <p class="mb-0">
                                    <strong class="@(comparison.UserCholesterol > comparison.AverageCholesterol ? "text-danger" : "text-success")">
                                        @comparison.UserCholesterol.ToString("F1")
                                    </strong> / @comparison.AverageCholesterol.ToString("F1") (TB)
                                </p>
                            </div>
                            <div class="col-md-3">
                                <h6>Nhịp Tim</h6>
                                <p class="mb-0">
                                    <strong class="@(Math.Abs(comparison.UserHeartRate - comparison.AverageHeartRate) > 10 ? "text-warning" : "text-success")">
                                        @comparison.UserHeartRate
                                    </strong> / @comparison.AverageHeartRate (TB)
                                </p>
                            </div>
                            <div class="col-md-12 mt-3">
                                <h6>Rủi ro (AI)</h6>
                                <p class="mb-0">
                                    Cá nhân: <strong>@comparison.UserRiskLevel.ToString("F1")%</strong> | Trung bình cộng đồng: <strong>@comparison.AverageRiskLevel.ToString("F1")%</strong> | Nguy cơ cao nhất: <strong>@comparison.HighestRiskDisease</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- ACTIONS -->
    <div class="row">
        <div class="col-12 text-center">
            <a href="@Url.Action("WeeklyReport", "Analytics")" class="btn btn-primary btn-lg">
                <i class="bi bi-file-earmark-text"></i> Xem Báo Cáo Tuần
            </a>
            <a href="@Url.Action("AddMetric", "Health")" class="btn btn-success btn-lg">
                <i class="bi bi-plus-circle"></i> Nhập Chỉ Số Mới
            </a>
            <a href="@Url.Action("Index", "Home")" class="btn btn-secondary btn-lg">
                <i class="bi bi-house"></i> Trang Chủ
            </a>
        </div>
    </div>
</div>
